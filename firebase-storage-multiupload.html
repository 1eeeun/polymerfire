<!--
@license
Copyright 2016 Google Inc. All Rights Reserved.
Use of this source code is governed by a BSD-style
license that can be found in the LICENSE file or at
https://github.com/firebase/polymerfire/blob/master/LICENSE
-->

<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="firebase-storage-behavior.html">
<script>
  (function(){
    'use strict';

    /**
    * The firebase-storage element is an easy way to interact with a firebase
    * storage as an object and expose it to the Polymer databinding system.
    *
    * For example:
    *
    *     <firebase-storage-multiupload
    *       path="/users/{{userId}}/files/{{filepath}}"
    *       files="[[fileArray]]"
    *       upload-tasks="{{uploadTasks}}">
    *     </firebase-storage-multiupload>
    *
    * This fetches the `fileArray` object, which is usually an array of Files,
    * or a FileList, which are then automatically uploaded to
    * `/users/${userId}/files/${filepath}` and then creates an array of upload
    * tasks that are exposed through the Polymer databinding system via the
    * `uploadTasks`. Changes to `fileArray` will likewise create a new set of
    * uploads, which creates a new set of tasks, which are appended to the
    * `uploadTasks`.
    *
    * `<firebase-storage>` needs some information about how to talk to Firebase.
    * Set this configuration by adding a `<firebase-app>` element anywhere in your
    * app.
    */
    Polymer({
      is: 'firebase-storage-multiupload',

      properties: {
        files: {
          type: Array
        },

        uploadTasks: {
          type: Array,
          notify: true,
          value: []
        },

        auto: {
          type: Boolean,
          value: false
        },

        forceUnique: {
          type: Boolean,
          value: false
        }
      },

      behaviors: [
        Polymer.FirebaseStorageBehavior
      ],

      /**
      * @override
      */
      get isNew() {
        return !this.path;
      },

      /**
      * @override
      */
      get zeroValue() {
        return [];
      },

      observers: [
        '__filesChanged(files, auto)'
      ],

      /**
      * Update the path and write this.files to that new location.
      *
      * Important note: `this.path` is updated asynchronously.
      *
      * @param {string} path of the new firebase location to write to.
      * @return {Promise} A promise that resolves once this.files has been
      *     written to the new path.
      * @override
      */
      upload: function(path) {
        return new Promise(function(resolve, reject) {
          if (!this.app) {
            reject(new Error('No app configured!'));
          }
          if (path) {
            resolve(this._putMultipleFirebaseFiles(path, this.files));
          } else if (this.path) {
            resolve(this._putMultipleFirebaseFiles(null, this.files));
          } else {
            resolve(this._putMultipleFirebaseFiles('/', this.files));
          }

          this.path = path ? this.path + '/' + path : this.path;
        }.bind(this));
      },

      /**
      * @override
      */
      reset: function() {
        this.path = null;
        this.clearTasks();
        return Promise.resolve();
      },

      /**
      * @override
      */
      clearTasks: function() {
        this.uploadTasks = this.zeroValue;
      },

      _putMultipleFirebaseFiles: function(path, files) {
        this._log('Putting Multiple Firebase files at',  path ? this.path + '/' + path : this.path);
        files = files && typeof files === 'object' && files.name ? [files] : files;
        if (files && files.length > 0) {
          for (var i = 0; i < files.length; i++) {
            var uploadTask = this._putFirebaseFile(path, files[i], this.metadata ? this.metadata : files[i].metadata);
            uploadTask.on(firebase.storage.TaskEvent.STATE_CHANGED, function(snapshot) {}, function(error) {
              this.fire('error', error, { bubble: false});
            }.bind(this));
            this.push('uploadTasks', uploadTask);
          }
        }
      },

      __filesChanged: function(files, auto) {
        if (auto) {
          this._putMultipleFirebaseFiles(null, files);
        }
      },

      __pathChanged: function(path, oldPath) {
        if (oldPath != null) {
          this.clearTasks();
        }
      },
    });
  })()

</script>
